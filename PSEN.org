#+TITLE: IB1 LN2 withdrawal piping system engineering note
#+LATEX_CLASS_OPTIONS: [titlepage]
#+OPTIONS: toc:nil tex:t
#+PROPERTY: header-args:python :session *python-PSEN* :results output :exports results

#+MACRO: SYS_NAME LN2 withdrawal piping
#+MACRO: P_ID F00304970

#+TITLE: IB1 Purifier panel connection piping amendment \newline {{{DOC_NUM}}}
#+LATEX_CLASS_OPTIONS: [titlepage]
#+LATEX_HEADER: \usepackage{xcolor}
#+OPTIONS: toc:nil tex:t

#+TOC: headlines 2
\newpage{}
#+begin_src python :results pp replate :exports none
  from wand.image import Image
  import fnmatch

  def make_pics(fname):
      """Create pictures of a PDF file with a given name"""
      pics = sorted(fnmatch.filter(os.listdir('images'), f'{fname}*.png'))
      if not pics:
          with Image(filename=f'images/{fname}.pdf', resolution = 200) as img:
              with img.convert('png') as converted:
                  converted.save(filename=f'images/{fname}_page.png')

      for pic_fn in pics:
          print(r'#+ATTR_LATEX: :width \textwidth')
          print(f'[[./images/{pic_fn}]]')
#+end_src

#+RESULTS:

#+begin_src python
  make_pics('Cover page')
#+end_src

#+RESULTS:
: #+ATTR_LATEX: :width \textwidth
: [[./images/Cover page_page-0.png]]
: #+ATTR_LATEX: :width \textwidth
: [[./images/Cover page_page-1.png]]
: #+ATTR_LATEX: :width \textwidth
: [[./images/Cover page_page-2.png]]

\newpage{}
* Setup                                                            :noexport:
#+begin_src sh :exports none
killall python
#+end_src

#+RESULTS:

#+begin_src python :results pp output replace :exports none
  import heat_transfer as ht
  from collections import namedtuple
  Component = namedtuple('Component', ['name', 'size', 'source', 'P'])
  ureg = ht.ureg
  Q_ = ht.Q_

  class Material():
      """Basic material class."""
      def __init__(self, name):
          self.name = name  # will be used in property calculations

          def kappa(self, T1, T2=None):
              """Calculate temperature conductivity at a given temperature."""
              return ht.nist_property(self.name, 'TC', T1, T2)

          def lin_exp(self, T):
              """Calculate linear expansion for given temperature"""
              try:
                  return ht.nist_property(self.name, 'LE', T)
              except KeyError:
                  return ht.nist_property(self.name, 'EC', 293*ureg.K, T)*(T-293*ureg.K)

  steel = Material('304SS')
  steel.rho = Q_('7859 kg/m**3')
  steel.S = Q_('16700 psi')  # 304L SS allowable stress
  steel.nu = 0.3  # Poisson's ratio
  steel.T_min = Q_('-425 degF')

  copper = Material('copper')
  copper.S = Q_('6000 psi')
  copper.T_min = Q_('-452 degF')

  P_des = 250 * ureg.psig
  T_des = 32 * ureg.degF

  pipes = [ht.piping.CopperTube(3/4, 'Type K', L=6*15*ureg.ft)
           ]
  for pipe in pipes:
      pipe.material = copper
  listed = [Component('Elbow', 3/4, 'Stockroom', 582*ureg.psi),
            Component('Elbow', 1, 'Stockroom', 494*ureg.psi),
            Component('Adapter SS to C', 3/4, 'McMaster 5520K227', 400*ureg.psi)
  ]
  unlisted = []
  print([(str(pipe), f'{pipe.L.to(ureg.ft):.2g~}', f'{pipe.volume.to(ureg.ft**3):.2g~}') for pipe in pipes])

  P_test = 1.1 * P_des
  pt_fluid_name = 'helium'
  pt_fluid = ht.ThermState(pt_fluid_name, P=P_test, T=ht.T_NTP)
#+end_src

#+RESULTS:
: [('0.75" Copper tube Type K', '90 ft', '0.27 ft ** 3')]

* Introduction
This document constitutes the piping engineering note for {{{SYS_NAME}}}.
The current version of the document is maintained in Team Center {{{DOC_NUM}}}.

During the 2020 IB1 Shutdown the LN2 withdrawal line inside IB1 will be removed. Remaining piping will be capped off at the tee (see [[fig:P_ID]] for details).

The design temperature is chosen to be
src_python{print(f'{T_des.to(ureg.K):.3g~}')}.

The design pressure for {{{SYS_NAME}}} is
src_python{print(f'{P_des.to(ureg.psig):.3g~}')}.


The P&ID of the {{{SYS_NAME}}} is shown in Figure [[fig:P_ID]].

#+CAPTION: The {{{SYS_NAME}}} as shown on P&ID {{{P_ID}}}.
#+NAME: fig:P_ID
[[./images/P_ID.png]]

* Design codes and evaluation criteria
All the piping must meet all of the requirements of Section 5031.1 of the Fermilab ES&H Manual.
#+begin_src python
  print('This section states that piping systems containing gas at a pressure ')
  if P_des > 150 * ureg.psig or T_des < -20 * ureg.degF:
      CATEGORY = 'Normal'
      print('above 150 psig or a temperature below -20 Fahrenheit fall under the category of Normal Fluid Service ')
  else:
      CATEGORY = 'D'
      print('below 150 psig and a temperature above -20 Fahrenheit fall under the Category D Fluid Service ')
  print('and shall adhere to the requirements of the ASME Process Piping Code B31.3.')
#+end_src

#+RESULTS:

* Materials
The tubing including fittings is fabricated from
#+begin_src python
print(pipes[0].material.name+'.')
#+end_src

#+RESULTS:

The respective allowable stress from Table A-1 of ASME B31.3 will be used in this analysis.

The {{{SYS_NAME}}} will be operated at temperatures down to src_python{print(f'{T_des.to(ureg.K):.3g~} ({T_des.to(ureg.degF):.3g})')}.
#+begin_src python
  aust_steel = ['304SS', '304LSS', '316SS', '321SS']
  Col_A = pipes[0].material.T_min < T_des
  Box_A4 = pipes[0].material.name in aust_steel and T_des < -20*ureg.degF
  Note_5 = all(pipe.wall < 0.098*ureg.inch for pipe in pipes)

  if Col_A:
    print(f'This is below the minimum temperature listed for any {pipes[0].material.name} pipe or tube.')
    if Box_A4:
      print('B31.3 Table 323.2.2 A-4 states that impact testing is required for austenitic stainless steels with design temperatures < -20 F except as provided in Note (5) and Note (6).')
      if Note_5:
        print('According to Note 5 of Table 323.2.2, impact testing is not required for this material when the minimum obtainable Charpy specimen has a width along the notch of less than 2.5 mm (0.098 in).')
        print('All of the tubing and piping with design minimum temperature below -20 F used in the system has a wall thickness of less than 0.098 in. Therefore, impact testing is not required for this piping system.')
    else:
      print('This is above the minimum temperature listed for all materials used in the system. According to B31.3 Section 323.2.2 (d), impact testing is not required for base metal of such piping.')
  else:
    print('*UPDATE DESCRIPTION*')


#+end_src

#+RESULTS:

According to Table 323.2.2, box A-6, there are no additional requirements for HAZ and the braze metal unless filler metal composition is outside the range for base metal composition. For copper brazing the filler metal will be significantly different from the base metal so the impact test will be required. Except for as stated in Note 5, when the maximum obtainable specimen has a width along the notch of less than 0.098 in. All of the piping in {{{SYS_NAME}}} satisfies the requirement of Note 5 (see Table [[tab:pipe_wall]]) and therefore is exempt from testing.

#+begin_comment
It should also be noted that Fermilab has extensive service experience using the 300 series stainless steel at liquid nitrogen temperatures and below.

Wall thickness of the 1.5” SCH 10 pipe is 0.109” which is greater than minimum obtainable Charpy specimen. According to Policy for Fracture Toughness Testing Requirements for Pressure Systems and Components at Low Cryogenic Temperatures  from 5/7/2010 recommends:
“As an alternative to B31.3 323.2.2 and Table 323.2.2 cells A‐4 and B‐4, high alloy steel materials (austenitic stainless steels) listed in Section VIII Div 1 Table UHA‐ 23 used in cryogenic piping with MDMTs colder than 77 K may instead be subjected to all requirements of UHA‐51.”
UHA-51 (g) exempts from impact testing materials listed in Table UHA-23, except as modified by UHA-51 (c), when ratio of design stress to allowable stress is less than 0.35. UHA-51 (c) (1) requires impact testing if the material has been thermally treated at temperatures between 900 F and 1650 F for austenitic steel. Off-the-shelf 304 and 316 steel is subject to annealing at temperatures above 1800 F and, therefore, is exempt from this requirement. As shown in Table 4.1, design stress to allowable stress ratio is less than 0.35 and impact testing is not required.

Minimum design temperature of He piping is 77 K. According to “Charpy Impact Testing at LN2 Temperature” Memo (ED0004216):
“All Charpy impact testing requirements have been satisfied for using 304 and 304L piping components with 308L filler metal and a wall thickness of less than 0.359”.  The extensive and successful experience Fermilab has had with the materials listed above has been reinforced with successful Charpy impact testing.  No further testing should be required for most LN2 piping assemblies fabricated by AD/Cryo as long as thickness requirements are met.”
All piping has wall thickness less than 0.359” and satisfies this requirement.
#+end_comment
Table [[tab:allowable_stress]] summarizes the materials used and the allowable stresses from B31.3 Table A-1.

#+begin_src python :results table :colnames '("Component"	"Material"	"Allowable Stress, psi")
  print([[pipes[0].type, pipes[0].material.name, f'{pipes[0].material.S.to(ureg.psi).magnitude:.0f}'], ['', '', '']])
#+end_src

#+CAPTION: Materials and Allowable Stress Values
#+NAME: tab:allowable_stress
#+RESULTS:
| Component          | Material | Allowable Stress, psi |
|--------------------+----------+-----------------------|
| Copper tube Type K | copper   |                  6000 |
|                    |          |                       |

* Piping design and analysis
The minimum required wall thickness is calculated using B31.3 304.1.2 and is shown in Table [[tab:pipe_wall]].

$$t=\frac{PD}{2(SEW+PY)}$$
#+begin_src python :results table :colnames '("Piping/tubing size	D, in"	"Min wall thick, in"	"Act thick, in"	"Wall thick ratio")
  E = 1
  W = 1
  Y = 0.4
  table = []
  for pipe in pipes:
    pipe.update(S=pipe.material.S, E=E, W=W, Y=Y)
    D = str(pipe.D) + '", ' + pipe.type
    t_min = pipe.pressure_design_thick(P_des)
    t_min_s = f'{t_min.to(ureg.inch).magnitude:.3g}'
    t_a = pipe.wall
    t_a_s = f'{t_a.to(ureg.inch).magnitude:.3g}'
    ratio = (t_a/t_min).to_base_units()
    ratio_s = f'{ratio:.3g~}'
    table.append([D, t_min_s, t_a_s, ratio_s])
  print(table)

#+end_src

#+CAPTION: Minimum required and actual wall thicknesses
#+NAME: tab:pipe_wall
#+RESULTS:
| Piping/tubing size	D, in | Min wall thick, in | Act thick, in | Wall thick ratio |
|---------------------------+--------------------+---------------+------------------|
| 0.75", Copper tube Type K |             0.0179 |         0.065 |             3.63 |
| 1", Copper tube Type K    |             0.0231 |         0.065 |             2.82 |


#+begin_src python :results table
table = []
table.append(['P = ', f'{P_des:.3g~}', 'Design pressure'])
table.append(['S = ', f'{pipes[0].material.S:.0f~}', 'Allowable stress, B31.3 A-1'])
table.append(['E = ', f'{E:.3g}', 'Quality factor, B31.3 A-1A, A-1B'])
table.append(['W = ', f'{W:.3g}', 'Weld joint stress reduction factor, B31.3 302.3.5(e)'])
table.append(['Y = ', f'{Y:.3g}', 'Coefficient, B31.3 304.1.1'])
print(table)
#+end_src

#+CAPTION: Values for wall thickness calculation
#+NAME: tab:des_parameters
#+RESULTS:
| P = | 250 psig | Design pressure                                      |
| S = | 6000 psi | Allowable stress, B31.3 A-1                          |
| E = |        1 | Quality factor, B31.3 A-1A, A-1B                     |
| W = |        1 | Weld joint stress reduction factor, B31.3 302.3.5(e) |
| Y = |      0.4 | Coefficient, B31.3 304.1.1                           |

All piping complies with this requirement.

#+begin_src python :results replace
  if listed:
    print('Listed components manufactured in accordance with the codes required by B31.3 Table 326.1 are presented in Table [[tab:listed]].')
  if unlisted:
    print('Unlisted components, those not included in B31.3 Table 326.1 as being manufactured according to published standards, installed in the system are shown in Table [[tab:unlisted]].')
#+end_src

#+RESULTS:

#+begin_comment
Extensive service experience at Fermilab allows the use of these components in piping systems as per B31.3 Section 304.7.2.
#+end_comment

#+begin_src python :results table :colnames '("Component" "Source and P/N" "Pressure rating, psig" "Design pressure, psig")
  def component_table(components):
    """Prepare a table of listed/unlisted components.

    Parameters
    ----------
    components : list
    """
    table = []
    for component in components:
      name = component.name + ', ' + str(component.size) + '"'
      source = component.source
      P = f'{component.P.to(ureg.psi).magnitude:.0f}'
      P_des_s = f'{P_des.to(ureg.psig).magnitude:.0f}'
      table.append((name, source, P, P_des_s))
    return table

  if listed:
    print(component_table(listed))
#+end_src

#+CAPTION: Listed piping components.
#+NAME: tab:listed
#+ATTR_LATEX: :align p{2cm}p{3cm}rr
#+RESULTS:
| Component    | Source and P/N | Pressure rating, psig | Design pressure, psig |
|--------------+----------------+-----------------------+-----------------------|
| Elbow, 0.75" | None           |                   582 |                   250 |
| Elbow, 1"    | None           |                   494 |                   250 |


#+begin_src python :results table :colnames '("Component" "Source and P/N" "Pressure rating, psig" "Design pressure, psig")
  if unlisted:
    print(component_table(unlisted))
#+end_src

#+CAPTION: Unlisted piping components.
#+NAME: tab:unlisted
#+RESULTS:
| Component    | Source and P/N | Pressure rating, psig | Design pressure, psig |
|--------------+----------------+-----------------------+-----------------------|
| Elbow, 0.75" | None           |                   582 |                   250 |
| Elbow, 1"    | None           |                   494 |                   250 |

* Pressure relief system
The {{{SYS_NAME}}} doesn't introduce any changes to the piping pressure relief. All modified parts are protected by respective reliefs of the IB1 cryosystem.

* Flexibility analysis
The {{{SYS_NAME}}} creates no additional constraints to IB1 piping.

* Welding and brazing inspection
#+begin_comment
All welding is made and certified by Fermilab. Completed inspection forms are included in the Appendix [[*Inspection forms]].
#+end_comment
All brazing is made and certified by Fermilab. Code required certifications, e.g. WPS, PQR, are available at [[https://www-tdserver1.fnal.gov/tdweb/ms/Policies/Welding/index.htm][Fermi welding procedures web page]]. Completed inspection forms are included in the Appendix [[*Inspection forms]].

* Pressure testing
#+begin_comment
345.2.5 for jacketed piping
67.5 psig with insulating vacuum
#+end_comment

The {{{SYS_NAME}}} will be pressure tested in accordance with B31.3
#+begin_src python
  if CATEGORY == 'Normal':
      print('345.5.4.')
      print(f'For a pneumatic test, the test pressure is 110% of the design pressure ({P_des:.3g~}) or {1.1*P_des:.3g~}.')
      print('The test medium will be gaseous nitrogen. After this document is reviewed and the pressure tests completed, copies of the witnessed pressure test permits will be included in the Appendix [[*Pressure testing permits]].')
  if CATEGORY == 'D':
      print('345.7 initial service leak test in accordance with 345.1 (a) for Category D piping.')
#+end_src

#+begin_comment
The {{{SYS_NAME}}} will be pressure tested in accordance with B31.3 345.5.4. For a pneumatic test, the test pressure is 110% of the design pressure (src_python{print(f'{P_des:.3g~}')}) or src_python{print(f'{P_test:.3g~}')}. The test medium will be gaseous helium.  After this document is reviewed and the pressure tests completed, copies of the witnessed pressure test permits will be included in the Appendix [[*Pressure testing permits]].
Procedure for pressure testing of {{{SYS_NAME}}} is attached in Appendix [[*Pressure testing procedure]].
#+end_comment
* Summary
The design of the {{{SYS_NAME}}} documented in this note is adequate to ensure that its operation presents no hazards to personnel.

* Appendix
** Inspection forms
#+begin_src python
  if CATEGORY == 'Normal':
      print('** Pressure testing permits')
      print('(Pressure test permits will be appended after this note is approved and the pressure tests are completed.)')
      print('[[./images/pressure_permit.png]]')
  make_pics('Examination')
#+end_src
** Pressure testing permits
#+begin_src python
  make_pics('Pressure_test')
#+end_src

#+RESULTS:

** Pressure testing procedure
*** Safety
The areas around the piping system must be roped off or barricaded to keep personnel out of the test area during the execution of this procedure.  Signs are to be posted warning personnel that a pressure test is in progress and to keep out of the area (per FESHM 5034 7.1.b.).  Follow Fermilab FESHM guidelines for proper PPE.

*** Hazards
This is a pneumatic pressure test utilizing compressed
src_python{print(f'{pt_fluid_name}')}
gas. There is potential for:
- Exposure to an asphyxiant
- Sudden release of pressure from piping
- Striking hazard due to failure of piping or piping components
The pressure test area will be roped off at a radius larger than an estimated blast radius (see Table [[tab:blast_radius]]).
#+begin_src python :results table :colnames '("Test fluid" "Stored energy, kJ" "Blast radius, m")
  piping = ht.piping.Piping(pt_fluid)
  piping.add(*pipes)
  E_stored = ht.stored_energy(piping)
  blast_radius = ht.blast_radius(E_stored)
  print([[str(piping.fluid), f'{E_stored.to(ureg.kJ).magnitude:.3g}',
          f'{max(blast_radius).to(ureg.m).magnitude:.3g}']])
#+end_src


#+CAPTION: Safety radius
#+NAME: tab:blast_radius
#+RESULTS:
| Test fluid                           | Stored energy     | Blast radius |
|--------------------------------------+-------------------+--------------|
| Helium at T = 293 K and P = 290 psi. | 2.25e+04 ft * lbf | 15.9 ft      |
|                                      |                   |              |

Ensure that the piping is securely mounted (per FESHM 5034 7.1.b.).

*** Test Equipment
Refer to Figure [[fig:setup]] for the layout of the test equipment.  The specific requirements for the components are listed in Table [[tab:equipment]]. The test equipment should be tested to be leak free before attaching it to the piping for the pressure test.

-	The relief valve must be tested prior to performing the pressure test procedure to ensure that it is operating properly (per FESHM 5034 7.2.d.).
-	The pressure test gauge (PI-3) calibration should be up-to-date (per FESHM 5034 7.2.b.).


#+NAME: fig:setup
#+CAPTION: P&ID of the Test Equipment
[[./images/pressure_test_setup.png]]

#+NAME: tab:equipment
#+CAPTION: Test Equipment Component Specification
| Component | Description           | Range                        |
| PI-1      | Supply Pressure Gauge | 400 psig                     |
| PSV-1     | Safety Relief Valve   | 300 psig (cracking pressure) |
| PI-3      | Test Pressure Gauge   | 400 psig                     |

*** Test Preparation
**** Isolate the piping from other portions of the facility.
1. Remove reliefs and plug pipe outlets:
   - [ ] PSV-1661
   - [ ] PSV-1662
   - [ ] PSV-1601
   - [ ] PSV-1602
2. Ensure following purifier panel valves *open*:
   - [ ] HV-1666
   - [ ] HV-1627A/B
   - [ ] HV-1669A/B
   - [ ] HV-1670A/B
   - [ ] HV-1665A/B
   - [ ] HV-1664A/B
   - [ ] HV-1661A/B
   - [ ] HV-1632A/B
   - [ ] HV-1631A/B
   - [ ] HV-1663A/B
   - [ ] HV-401 ALT (any direction)
3. Ensure following valves *closed*:
   - Purifier panel
     - [ ] HV-1662
     - [ ] HV-1603
     - [ ] HV-1666A
     - [ ] HV-1626A/B
     - [ ] HV-1612A/B
     - [ ] HV-1625A/B
     - [ ] HV-1668A/B
     - [ ] HV-1633A/B
     - [ ] HV-1630A/B
     - [ ] HV-1629A/B
     - [ ] HV-1628A/B
   - Turbine scrub
     - [ ] HV-34
   - Compressor middle stage
     - [ ] PCV-1406
   - Dist box
     - [ ] HV-401
     - [ ] HV-8 ALT
     - [ ] HV-1761
   - Mycom suction
     - [ ] YCV-1703
     - [ ] HV-1703-C
   - Storage dewar
     - [ ] HV-315
   - Buffer tanks
     - [ ] HV-140
**** Connect Test Equipment
1. Setup the test equipment in a safe location outside the roped off area.
2. Install the pressure test gauge PI-3.
3. Connect the test gas connection from MV-3.
**** Perform the pressure test according to section [[*Pressure Test]].
**** Switch HV-401 ALT to alternative direction
**** Perform the pressure test according to section [[*Pressure Test]].
*** Pressure Test
During this test procedure, the pressure will be increased in steps waiting at each step to verify that the pressure remains constant.  If at any time a leak is suspected, reduce the pressure to half of the value for the current step and check for leaks with the soap bubble method.  When a leak is found, the piping must be depressurized before repairing the leak.  (per FESHM 5034 7.3.b. and 3.c.)

1. Increase the pressure in the piping to 25 psig.  Wait 5 minutes.  If no leak is detected, proceed to the next step.
2. Increase the pressure to test pressure with increment of no more than 50 psig.  Wait 5 minutes at each step.  If no leak is detected proceed to next pressure increase step. After reaching the test pressure wait 10 minutes.  If no leak is evident, reduce pressure to design pressure and check all seams and fittings with soap bubble or alternate leak detection method.  (per FESHM 5034 7.3.a and B31.3 345.5.5)
3. When all leak checks have been performed and no leaks exist, depressurize the piping.
4. Restore the system back to its original configuration.
5. Remove the rope/barricades and signs.
